<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FieldOpsSuite – Repositories</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, 'Noto Sans', Helvetica, Arial, 'Apple Color Emoji', 'Segoe UI Emoji'; margin: 0; }
      header { padding: 16px 20px; border-bottom: 1px solid #8884; display:flex; align-items:center; gap:12px; }
      header h1 { font-size: 18px; margin: 0; }
      main { padding: 20px; max-width: 960px; margin: 0 auto; }
      .repo { border: 1px solid #8884; border-radius: 10px; padding: 12px 14px; margin-bottom: 12px; display:flex; justify-content:space-between; align-items:center; gap: 12px; }
      .meta { color: #888; font-size: 12px; }
      .actions { display:flex; gap: 8px; }
      button, a.button { padding: 8px 12px; border-radius: 8px; border: 1px solid #8884; background: transparent; cursor: pointer; text-decoration:none; color: inherit; }
      button:hover, a.button:hover { background: #8882; }
      .empty { color: #888; padding: 24px; border: 1px dashed #8886; border-radius: 10px; }
      footer { padding: 16px 20px; border-top: 1px solid #8884; text-align:center; font-size:12px; color:#888 }
    </style>
  </head>
  <body>
    <header>
      <h1>FieldOpsSuite – Repositories</h1>
      <span class="meta" id="repo-count"></span>
      <span style="margin-left:auto"></span>
      <a class="button" href="/heatmapOverlay.json" target="_blank">Heatmap JSON</a>
      <a class="button" href="/../digests/weekly.md" target="_blank">Weekly Digest</a>
    </header>
    <main>
      <div id="list"></div>
      <div id="empty" class="empty" style="display:none">No repositories found. Run scan and refresh.</div>
    </main>
    <footer>
      FieldOpsSuite_v1 – Modular Logistics Intelligence Platform
    </footer>
    <script>
      async function loadRepos() {
        const listEl = document.getElementById('list');
        const emptyEl = document.getElementById('empty');
        const countEl = document.getElementById('repo-count');
        listEl.innerHTML = '';
        try {
          const res = await fetch('/api/repos');
          if (!res.ok) throw new Error('Failed to load repos');
          const repos = await res.json();
          countEl.textContent = repos.length ? `(${repos.length})` : '';
          if (!repos.length) { emptyEl.style.display = 'block'; return; }
          emptyEl.style.display = 'none';
          for (const repo of repos) {
            const row = document.createElement('div');
            row.className = 'repo';

            const left = document.createElement('div');
            left.innerHTML = `<div><strong>${repo.name}</strong> ${repo.provider ? `<span class="meta">· ${repo.provider}</span>` : ''}</div><div class="meta">${repo.path}${repo.remote ? ' · ' + repo.remote : ''}</div>`;

            const actions = document.createElement('div');
            actions.className = 'actions';

            if (repo.remote && /^https?:\/\//.test(repo.remote)) {
              const openRemote = document.createElement('a');
              openRemote.className = 'button';
              openRemote.href = repo.remote;
              openRemote.target = '_blank';
              openRemote.textContent = 'Open Remote';
              actions.appendChild(openRemote);
            }

            if (repo.buildsUrl) {
              const openBuilds = document.createElement('a');
              openBuilds.className = 'button';
              openBuilds.href = repo.buildsUrl;
              openBuilds.target = '_blank';
              openBuilds.textContent = 'Builds';
              actions.appendChild(openBuilds);
            }

            const openLocal = document.createElement('a');
            openLocal.className = 'button';
            openLocal.href = `vscode://file/${encodeURIComponent(repo.path)}`;
            openLocal.textContent = 'Open in Editor';
            actions.appendChild(openLocal);

            const browseFs = document.createElement('a');
            browseFs.className = 'button';
            browseFs.href = repo.path.startsWith('/') ? `file://${repo.path}` : repo.path;
            browseFs.textContent = 'Browse Files';
            actions.appendChild(browseFs);

            const installBtn = document.createElement('button');
            installBtn.textContent = 'Install App';
            installBtn.onclick = async () => {
              installBtn.disabled = true;
              installBtn.textContent = 'Installing…';
              try {
                const resp = await fetch('/api/install', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ repo })});
                const data = await resp.json();
                if (!resp.ok) throw new Error(data && data.error || 'Install failed');
                installBtn.textContent = 'Installed';
              } catch (e) {
                installBtn.textContent = 'Install Failed';
                alert('Install error: ' + e.message);
              } finally {
                setTimeout(() => { installBtn.disabled = false; installBtn.textContent = 'Install App'; }, 1500);
              }
            };
            actions.appendChild(installBtn);

            row.appendChild(left);
            row.appendChild(actions);
            listEl.appendChild(row);
          }
        } catch (err) {
          countEl.textContent = '';
          emptyEl.style.display = 'block';
          emptyEl.textContent = 'Failed to load repositories: ' + err.message;
        }
      }
      loadRepos();
    </script>
  </body>
  </html>

